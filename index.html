<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>English-textbook-Reading_V0</title>
    <style>
      body {
          background: #f3f4f6;
          font-family: 'Segoe UI', 'Meiryo', sans-serif;
          margin: 0;
          padding: 0;
      }

      .container {
          position: relative;
          width: 100%;
          max-width: 420px;
          margin: 2rem auto;
          background: #fff;
          border-radius: 16px;
          box-shadow: 0 4px 16px rgba(0,0,0,0.08);
          padding: 2rem 1rem 2rem 1rem;
      }

      .title {
          text-align: center;
          font-size: 2rem;
          font-weight: bold;
          color: #222;
          margin-bottom: 1.5rem;
      }

      .flashcard-page .title {
          font-size: 1rem;
          font-weight: 600;
          text-align: left;
          margin-bottom: 0.5rem;
          width: 100%;
      }
      
      .card-header-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 0.5rem;
        min-height: 38px; /* To prevent layout shift if button is not present */
      }
      
      .card-number {
          text-align: left;
          font-size: 1rem;
          color: #6b7280;
          height: 1.2rem;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          flex-grow: 1;
      }
      
      #relatedWordsBtn {
          flex-shrink: 0;
      }


      .list-card {
          background: #f9fafb;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.06);
          padding: 1.2rem 1rem;
          margin-bottom: 1.2rem;
      }

      .list-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.7rem;
          border-bottom: 1px solid #e5e7eb;
          padding-bottom: 0.3rem;
          gap: 0.5rem;
      }

      .list-title {
          font-size: 1.2rem;
          font-weight: 600;
          color: #333;
          margin: 0;
          border: none;
          padding: 0;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }
      
      .list-header-buttons {
          display: flex;
          gap: 0.5rem;
          flex-shrink: 0;
      }

      .header-btn {
          color: white;
          border: none;
          border-radius: 6px;
          padding: 0.3rem 0.8rem;
          font-size: 0.9rem;
          font-weight: 500;
          cursor: pointer;
          transition: background 0.2s;
          flex-shrink: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 0.3em;
      }
      .delete-btn {
          background: #ef4444;
          color: white;
      }
      .delete-btn:hover {
          background: #dc2626;
      }

      .progress-info {
          font-size: 0.8rem;
          color: #6b7280;
          margin-bottom: 0.7rem;
          text-align: center;
          background: #e5e7eb;
          padding: 0.3rem 0;
          border-radius: 6px;
      }

      .list-btns {
          display: flex;
          justify-content: center;
      }

      .mode-btn {
          width: 100%;
          padding: 0.7rem 0;
          border: none;
          border-radius: 8px;
          font-size: 1rem;
          font-weight: bold;
          color: #fff;
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.07);
          transition: background 0.2s;
      }
      .mode-btn.learn { background: #3b82f6; }
      .mode-btn.learn:hover:not(:disabled) { background: #2563eb; }

      .add-btn {
          width: 100%;
          max-width: 260px;
          padding: 0.8rem 0;
          background: #22c55e;
          color: #fff;
          font-weight: bold;
          border: none;
          border-radius: 10px;
          font-size: 1.1rem;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          cursor: pointer;
          transition: background 0.2s, transform 0.2s;
      }
      .add-btn:hover {
          background: #16a34a;
          transform: scale(1.04);
      }
      
      .card-container {
          width: 100%;
          max-width: 400px;
          min-height: 250px;
          perspective: 1000px;
          cursor: pointer;
          margin: 0 auto 1.5rem auto;
      }

      .card {
          width: 100%;
          position: relative;
          transform-style: preserve-3d;
          transition: transform 0.6s, height 0.4s ease-out;
      }

      .card.is-flipped {
          transform: rotateY(180deg);
      }

      .card-face {
          position: absolute;
          width: 100%;
          backface-visibility: hidden;
          display: flex;
          justify-content: flex-start;
          align-items: flex-start;
          border-radius: 15px;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
          padding: 1.5rem;
          text-align: left;
          word-break: break-word;
          box-sizing: border-box; /* This ensures padding is inside the element's width/height */
      }

      .card-front {
          background: #fefce8; /* 薄い黄色 */
          color: #111827;      /* 黒字 */
          font-size: 1.5rem;
          font-weight: bold;
      }

      .card-back {
          background: #f0f9ff; /* 薄い水色 */
          color: #111827;      /* 黒字 */
          font-size: 1.1rem;
          font-weight: 600;
          transform: rotateY(180deg);
      }

      .done-card .card-front {
          font-size: 2rem;
          color: #15803d; /* 完了テキストを緑色に */
          /* Re-center done text */
          justify-content: center;
          align-items: center;
          text-align: center;
      }
      
      .grammar-box {
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
          margin-top: 1rem;
          margin-bottom: 1rem;
          padding: 0.8rem;
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          background: #f9fafb;
          text-align: left;
      }

      .grammar-placeholder {
          height: 90px; /* 文法ボックスのおおよその高さ */
          margin-top: 1rem;
          margin-bottom: 1rem;
      }

      .grammar-item {
          font-size: 1rem;
          color: #374151;
      }

      .grammar-item span {
          font-weight: bold;
          color: #111827;
          margin-right: 0.5em;
      }


      .counters {
          display: flex;
          justify-content: center;
          margin-bottom: 1rem;
          font-size: 1rem;
          color: #444;
      }

      .counters span {
          margin: 0 1em; /* Add horizontal spacing between counters */
      }

      .btn-row {
          display: flex;
          justify-content: space-around;
          gap: 1rem;
          margin-bottom: 1rem;
      }

      .btn-row button {
          flex: 1;
          padding: 0.8rem 1rem;
          border: none;
          border-radius: 8px;
          font-size: 1.1rem;
          font-weight: bold;
          color: #fff;
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.07);
          transition: background 0.2s;
          white-space: nowrap; 
      }
      
      .btn-row button:disabled {
          background-color: #d1d5db;
          cursor: not-allowed;
          color: #6b7280;
          transform: none;
      }

      #checkBtn, #nextBtn {
          color: black;
      }

      .check-btn { background: #f59e42; }
      .check-btn:hover:not(:disabled) { background: #ea580c; }
      .check-btn.checked { background: #fb923c; border: 2px solid #f97316; }

      .next-btn { background: #22c55e; }
      .next-btn:hover:not(:disabled) { background: #16a34a; }
      
      .sub-btn-row {
          display: flex;
          justify-content: center;
          gap: 1rem;
          margin-bottom: 1rem;
      }

      .sub-btn {
          padding: 0.5rem 1.2rem;
          background: #e5e7eb;
          color: #333;
          border: none;
          border-radius: 7px;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          transition: background 0.2s;
      }
      .sub-btn:hover {
          background: #d1d5db;
      }
      
      #prevBtn {
          background-color: #a3e635; /* 黄緑 */
          color: #1f2937;
      }
      #prevBtn:hover:not(:disabled) {
          background-color: #84cc16;
      }
      #suspendBtn {
          background-color: #fde047; /* 黄色 */
          color: #1f2937;
      }
      #suspendBtn:hover {
          background-color: #facc15;
      }
      #resetBtn {
          background-color: #fca5a5; /* 薄い赤 */
          color: #1f2937;
      }
      #resetBtn:hover {
          background-color: #f87171;
      }
      #reviewBtn {
          background-color: #7dd3fc; /* 水色 */
          color: #1f2937;
      }
      #reviewBtn:hover {
          background-color: #38bdf8;
      }
      #relatedWordsBtn {
          background-color: #c4b5fd; /* 薄紫 */
          color: #1f2937;
      }
      #relatedWordsBtn:hover {
          background-color: #a78bfa;
      }

      .speech-controls {
          display: flex;
          flex-direction: row;
          align-items: center;
          justify-content: center;
          gap: 0.75rem;
          margin: 1rem auto;
          width: 100%;
          max-width: 420px;
          padding: 0 1rem;
          box-sizing: border-box;
      }

      .speech-controls .sub-btn {
          padding: 0.5rem 1rem;
          font-size: 1rem;
          flex-shrink: 0;
      }

      .speech-controls label {
          font-size: 0.9rem;
          color: #4b5563;
          flex-shrink: 0;
          margin: 0;
      }

      .speech-controls input[type="range"] {
          width: 100%;
          max-width: 160px;
          cursor: pointer;
      }
      
      #speechRateValue {
        font-size: 0.9rem;
        color: #4b5563;
        font-weight: 500;
        min-width: 2.2em;
        text-align: right;
      }

      .back-link {
          background: none;
          border: none;
          color: #3b82f6;
          font-size: 1rem;
          cursor: pointer;
          text-decoration: underline;
          margin-top: 1.5rem;
      }
      .back-link:hover {
          color: #1d4ed8;
      }

      .flashcard-page {
          display: flex;
          flex-direction: column;
          align-items: center;
      }
      .mt-8 {
          margin-top: 2rem;
      }
      .text-center {
          text-align: center;
      }

      #settingsBtn {
          position: absolute;
          top: 1rem;
          right: 1rem;
          background: none;
          border: none;
          font-size: 1.8rem;
          cursor: pointer;
          color: #6b7280;
          transition: color 0.2s, transform 0.2s;
      }
      #settingsBtn:hover {
          color: #1f2937;
          transform: rotate(30deg);
      }

      /* Modal Styles */
      .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          transition: opacity 0.3s ease;
      }

      .modal-content {
          background: #fff;
          padding: 1.5rem 2rem;
          border-radius: 12px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.3);
          width: 90%;
          max-width: 400px;
          transform: translateY(-20px);
          transition: transform 0.3s ease;
      }

      .modal-overlay:not([style*="display: none"]) .modal-content {
        transform: translateY(0);
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 1px solid #e5e7eb;
          padding-bottom: 0.8rem;
          margin-bottom: 1rem;
      }

      .modal-header h2 {
          margin: 0;
          font-size: 1.4rem;
          color: #333;
      }

      .close-button {
          background: none;
          border: none;
          font-size: 2rem;
          font-weight: bold;
          color: #aaa;
          cursor: pointer;
          line-height: 1;
      }
      .close-button:hover {
          color: #333;
      }
      
      .modal-body {
          max-height: 60vh;
          overflow-y: auto;
      }
      
      /* List Selection Page */
      .list-selection-page {
          display: flex;
          flex-direction: column;
      }
      .list-selection-page .title {
          font-size: 1.5rem;
          margin-bottom: 0;
          text-align: left;
      }
      .list-selection-page .list-header {
          margin-bottom: 1.5rem;
          padding-bottom: 0;
          border-bottom: none;
      }
      .selection-list {
          list-style: none;
          padding: 0;
          margin: 0;
      }
      .selection-list li {
          background: #f9fafb;
          border: 1px solid #e5e7eb;
          padding: 1rem;
          border-radius: 10px;
          margin-bottom: 0.75rem;
          cursor: pointer;
          transition: background-color 0.2s, border-color 0.2s;
          font-size: 1.1rem;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      .selection-list li:hover {
          background-color: #f3f4f6;
          border-color: #d1d5db;
      }
      .selection-list .item-type-badge {
          font-size: 0.75rem;
          font-weight: bold;
          padding: 0.2em 0.6em;
          border-radius: 10px;
          background-color: #c4b5fd;
          color: #3730a3;
          margin-left: 0.5em;
          flex-shrink: 0;
      }


      .settings-form-group {
          margin-bottom: 1rem;
      }
      .settings-form-group label {
          display: block;
          font-weight: 500;
          margin-bottom: 0.3rem;
          color: #374151;
      }
      .settings-form-group input[type="text"],
      .settings-form-group input[type="number"],
      .settings-form-group input[type="file"] {
          width: 100%;
          padding: 0.5rem;
          border: 1px solid #d1d5db;
          border-radius: 6px;
          font-size: 1rem;
          box-sizing: border-box;
      }
      .modal-footer {
          display: flex;
          justify-content: flex-end;
          gap: 0.5rem;
          margin-top: 1rem;
      }

      /* Password Modal */
      #passwordModal .modal-content {
          max-width: 320px;
      }
      #passwordInput {
          width: 100%;
          padding: 0.8rem;
          font-size: 1.2rem;
          text-align: center;
          letter-spacing: 0.5em;
          border: 1px solid #ccc;
          border-radius: 8px;
          margin-bottom: 1rem;
          box-sizing: border-box;
      }
      #passwordError {
          color: #ef4444;
          height: 1.2em;
          margin-bottom: 0.5rem;
          font-size: 0.9em;
          text-align: center;
      }
      #passwordSubmitBtn {
          width: 100%;
          max-width: none;
      }
      
      .related-item {
        font-size: 1.1em;
        margin: 0.6em 0;
        line-height: 1.4;
      }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="app"></div>
    <input type="file" id="localDirectoryInput" webkitdirectory directory style="display: none;">

    <div id="passwordModal" class="modal-overlay" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>パスワード入力</h2>
          <button id="closePasswordModalBtn" class="close-button">&times;</button>
        </div>
        <p style="text-align: center; margin-top: 0; margin-bottom: 1rem;">設定用のパスワード(4桁)</p>
        <input type="password" id="passwordInput" maxlength="4" inputmode="numeric" pattern="\d*">
        <div id="passwordError"></div>
        <button id="passwordSubmitBtn" class="add-btn">確認</button>
      </div>
    </div>
    
    <div id="settingsModal" class="modal-overlay" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>TSV列設定</h2>
          <button class="close-button">&times;</button>
        </div>
        <div class="modal-body">
            <p>TSVファイルの各データが何列目にあるかを指定してください。(0で無効)</p>
            <form id="settingsForm">
                <div class="settings-form-group">
                    <label for="colEnglish">英語 (カード表)</label>
                    <input type="number" id="colEnglish" data-key="english" min="1">
                </div>
                <div class="settings-form-group">
                    <label for="colJapanese">日本語 (カード裏)</label>
                    <input type="number" id="colJapanese" data-key="japanese" min="1">
                </div>
                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e5e7eb;">
                <div class="settings-form-group">
                    <label for="colNo">番号 (No)</label>
                    <input type="number" id="colNo" data-key="no" min="0">
                </div>
                <div class="settings-form-group">
                    <label for="colUnit">ユニット (Unit)</label>
                    <input type="number" id="colUnit" data-key="unit" min="0">
                </div>
                <div class="settings-form-group">
                    <label for="colLabel">ラベル (label)</label>
                    <input type="number" id="colLabel" data-key="label" min="0">
                </div>
                <div class="settings-form-group">
                    <label for="colGram1">文法1 (gram1)</label>
                    <input type="number" id="colGram1" data-key="gram1" min="0">
                </div>
                <div class="settings-form-group">
                    <label for="colGram2">文法2 (gram2)</label>
                    <input type="number" id="colGram2" data-key="gram2" min="0">
                </div>
                <div class="settings-form-group">
                    <label for="colGram3">文法3 (gram3)</label>
                    <input type="number" id="colGram3" data-key="gram3" min="0">
                </div>
            </form>
        </div>
        <div class="modal-footer">
           <button id="saveSettingsBtn" class="mode-btn learn">保存</button>
           <button id="resetSettingsBtn" class="sub-btn">リセット</button>
        </div>
      </div>
    </div>

    <script>
      let dynamicLists = [];
      let currentList = null;
      let progressData = {}; 
      let columnSettings = {};
      let speechRate = 1.0;
      const app = document.getElementById("app");

      const LISTS_KEY = 'flashcard_lists';
      const PROGRESS_KEY = 'flashcard_progress';
      const SETTINGS_KEY = 'flashcard_settings';
      const SPEECH_RATE_KEY = 'flashcard_speech_rate';
      const defaultColumnSettings = { english: 4, japanese: 5, no: 1, unit: 2, label: 3, gram1: 6, gram2: 7, gram3: 8 };

      function saveState() {
          try {
              localStorage.setItem(LISTS_KEY, JSON.stringify(dynamicLists));
              localStorage.setItem(PROGRESS_KEY, JSON.stringify(progressData));
              localStorage.setItem(SETTINGS_KEY, JSON.stringify(columnSettings));
          } catch (e) {
              console.error("Failed to save state:", e);
              alert("データの保存に失敗しました。");
          }
      }

      function loadState() {
          try {
              const savedLists = localStorage.getItem(LISTS_KEY);
              const savedProgress = localStorage.getItem(PROGRESS_KEY);
              const savedSettings = localStorage.getItem(SETTINGS_KEY);
              const savedRate = localStorage.getItem(SPEECH_RATE_KEY);

              if (savedLists) {
                  dynamicLists = JSON.parse(savedLists);
              }
              if (savedProgress) {
                  progressData = JSON.parse(savedProgress);
              }
              if (savedSettings) {
                  columnSettings = JSON.parse(savedSettings);
              } else {
                  columnSettings = { ...defaultColumnSettings };
              }
              if (savedRate !== null) {
                  speechRate = parseFloat(savedRate);
              }

              // Ensure all keys from default are present
              columnSettings = { ...defaultColumnSettings, ...columnSettings };

          } catch (e) {
              console.error("Failed to load state:", e);
              localStorage.removeItem(LISTS_KEY);
              localStorage.removeItem(PROGRESS_KEY);
              localStorage.removeItem(SETTINGS_KEY);
              localStorage.removeItem(SPEECH_RATE_KEY);
          }
      }

      function showHomePage() {
        app.innerHTML = `
          <div class="container">
            <button id="settingsBtn" title="設定">⚙️</button>
            <h1 class="title">English-textbook-Reading_V0</h1>
            <div id="lists"></div>
            <div class="mt-8 text-center">
              <button id="addContentBtn" class="add-btn"></button>
            </div>
          </div>
        `;
        
        const listsDiv = document.getElementById("lists");

        if (dynamicLists.length === 0) {
            listsDiv.innerHTML = '<p style="text-align: center; color: #6b7280;">リストを追加してください。</p>';
        } else {
            const listsHtml = dynamicLists.map(list => {
                const listId = list.id;
                const progress = progressData[listId];
                let progressHtml = '';

                if (progress && progress.words && progress.visitedIndices) {
                    const total = progress.words.length;
                    const idx = progress.idx;
                    const checkedCount = progress.checkedItems.length;
                    const remainingCount = total - idx;
                    const perfectCount = idx - checkedCount;
                    progressHtml = `<div class="progress-info">のこり${remainingCount}枚 / カンペキ${perfectCount}枚 / check！${checkedCount}枚</div>`;
                }
                
                const displayName = list.name;

                return `
                <div class="list-card">
                  <div class="list-header">
                    <h2 class="list-title" title="${list.name}">${displayName}</h2>
                    <div class="list-header-buttons">
                        <button class="header-btn delete-btn" data-id="${listId}" title="削除">🗑️ (削除)</button>
                    </div>
                  </div>
                  ${progressHtml}
                  <div class="list-btns">
                    <button class="mode-btn learn" data-id="${listId}">学習する</button>
                  </div>
                </div>
              `;
            }).join("");
            listsDiv.innerHTML = listsHtml;
        }

        document.querySelectorAll(".mode-btn").forEach((btn) => {
          btn.onclick = () => {
            const listId = parseInt(btn.dataset.id, 10);
            currentList = dynamicLists.find(l => l.id === listId);
            const progress = progressData[listId];
            if (progress && progress.words && progress.visitedIndices) {
              if (confirm("中断したセッションを再開しますか？\n（「キャンセル」で最初から始めます）")) {
                showFlashcardPage(progress);
                return;
              } else {
                delete progressData[listId];
                saveState();
              }
            }
            showFlashcardPage();
          };
        });
        
        document.querySelectorAll(".delete-btn").forEach((btn) => {
            btn.onclick = (e) => {
                e.stopPropagation();
                const listId = parseInt(btn.dataset.id, 10);
                const listToDelete = dynamicLists.find(list => list.id === listId);
                if (listToDelete && confirm(`「${listToDelete.name}」を削除しますか？\n保存されている進捗も失われます。`)) {
                    dynamicLists = dynamicLists.filter(list => list.id !== listId);
                    delete progressData[listId];
                    saveState();
                    showHomePage();
                }
            };
        });
        
        document.getElementById("settingsBtn").onclick = openPasswordModal;

        const addContentBtn = document.getElementById("addContentBtn");
        const localDirectoryInput = document.getElementById("localDirectoryInput");
        
        const isLocal = window.location.protocol === 'file:';
        if (isLocal) {
            addContentBtn.textContent = 'PCからリストを追加';
            addContentBtn.onclick = () => localDirectoryInput.click();
            localDirectoryInput.onchange = handleLocalDirectorySelect;
        } else {
            addContentBtn.textContent = 'リストを選択';
            addContentBtn.onclick = () => {
                fetch('./manifest.json')
                  .then(response => {
                    if (!response.ok) {
                      throw new Error('manifest.jsonが見つかりません。');
                    }
                    return response.json();
                  })
                  .then(data => {
                    showListPage(data);
                  })
                  .catch(error => {
                    console.error('Error loading manifest:', error);
                    alert(`エラー: ${error.message}\nサーバーのルートにmanifest.jsonを設置してください。`);
                  });
            };
        }
      }

      function parseTsv(text) {
        return text.trim().split(/\r?\n/).map((line) => {
            const columns = line.split("\t");
            const requiredColsExist = columnSettings.english > 0 && 
                                      columnSettings.japanese > 0 &&
                                      columns.length >= Math.max(columnSettings.english, columnSettings.japanese) &&
                                      columns[columnSettings.english - 1] &&
                                      columns[columnSettings.japanese - 1];
            
            return columns.length > 1 ? { columns: columns.map(c => c.trim()) } : null;
        }).filter(word => word !== null);
      }

      function handleLocalDirectorySelect(event) {
        const files = event.target.files;
        if (!files || files.length === 0) return;

        const fileList = Array.from(files);

        if (files[0].webkitRelativePath === undefined) {
             alert('お使いのブラウザはフォルダ選択に対応していないようです。Google Chrome, Firefox, Microsoft Edge の最新版でお試しください。');
             event.target.value = '';
             return;
        }
        
        let manifestFile = null;
        let minPathDepth = Infinity;

        for (const file of fileList) {
            if (!file.webkitRelativePath) continue;
            if (file.name === 'manifest.json') {
                const depth = file.webkitRelativePath.split('/').length;
                if (depth < minPathDepth) {
                    minPathDepth = depth;
                    manifestFile = file;
                }
            }
        }

        if (!manifestFile) {
            alert('選択したフォルダに manifest.json が見つかりませんでした。「Unit 1」などの個別フォルダではなく、`manifest.json`が含まれるプロジェクト全体のフォルダを選択してください。');
            event.target.value = '';
            return;
        }
        
        const manifestPathParts = manifestFile.webkitRelativePath.split('/');
        const rootDir = manifestPathParts.length > 1 ? manifestPathParts.slice(0, -1).join('/') + '/' : '';
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const manifestData = JSON.parse(e.target.result);
                showListPage(manifestData, { fileList: fileList, rootDir: rootDir });
            } catch (error) {
                console.error("manifest.json の解析に失敗しました:", error);
                alert("manifest.json の形式が正しくありません。");
            }
        };
        reader.onerror = () => {
            alert('manifest.json の読み込みに失敗しました。');
        };
        reader.readAsText(manifestFile);
        
        event.target.value = '';
      }
      
      function showListPage(data, localDataContext = null) {
        app.innerHTML = `
          <div class="container list-selection-page">
            <div class="list-header">
                <h1 class="title">リストを選択</h1>
            </div>
            <div id="selectionListContainer">
              <p>読み込み中...</p>
            </div>
            <div class="mt-8 text-center">
                <button id="backToHomeBtn" class="back-link">« ホームページに戻る</button>
            </div>
          </div>
        `;

        const selectionContainer = document.getElementById('selectionListContainer');
        
        const hasSets = data.sets && data.sets.length > 0;
        const hasFiles = data.single_files && data.single_files.length > 0;
        
        if (!hasSets && !hasFiles) {
          selectionContainer.innerHTML = '<p>利用可能なファイルがありません。</p>';
          return;
        }

        const ul = document.createElement('ul');
        ul.className = 'selection-list';
        
        const createClickHandler = (item) => async () => {
            selectionContainer.innerHTML = `<p>${item.name || item.split('/').pop()}を読み込み中...</p>`;
            try {
                if (localDataContext) {
                    await loadItemFromLocal(item, localDataContext);
                } else {
                    await loadItemFromRepo(item);
                }
            } catch (error) {
                showListPage(data, localDataContext);
            }
        };

        if (hasSets) {
          data.sets.forEach(set => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${set.name}</span> <span class="item-type-badge">セット</span>`;
            li.onclick = createClickHandler(set);
            ul.appendChild(li);
          });
        }

        if(hasFiles) {
          data.single_files.forEach(filename => {
            const li = document.createElement('li');
            li.textContent = filename.split('/').pop();
            li.onclick = createClickHandler(filename);
            ul.appendChild(li);
          });
        }

        selectionContainer.innerHTML = '';
        selectionContainer.appendChild(ul);

        document.getElementById('backToHomeBtn').onclick = showHomePage;
      }
      
      async function loadItemFromLocal(item, localDataContext) {
        const { fileList, rootDir } = localDataContext;

        const readFileFromList = (path, files) => new Promise((resolve, reject) => {
            if (path === null || path === undefined) return resolve("");

            const fullPath = rootDir + path;
            const fileToRead = files.find(f => f.webkitRelativePath === fullPath);

            if (!fileToRead) {
                return reject(new Error(`ファイル '${path}' が見つかりません。manifest.jsonのパスが正しいか確認してください。`));
            }
            
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = e => reject(e);
            reader.readAsText(fileToRead);
        });

        try {
            if (typeof item === 'string') { // Single file
                const text = await readFileFromList(item, fileList);
                const words = parseTsv(text);
                if (words.length > 0) {
                    dynamicLists.push({ id: Date.now(), name: item.split('/').pop(), words });
                } else {
                    throw new Error("ファイルが空か、形式が正しくありません。");
                }
            } else if (typeof item === 'object' && item.s_file) { // Set of files
                const [sText, tText, gText] = await Promise.all([
                    readFileFromList(item.s_file, fileList),
                    readFileFromList(item.t_file, fileList),
                    readFileFromList(item.g_file, fileList)
                ]);

                const sData = parseTsv(sText);
                if (sData.length === 0) throw new Error('メイン英文ファイルに有効なデータがありません。');
                
                const tData = tText ? parseTsv(tText) : [];
                const gData = gText ? parseTsv(gText) : [];
                
                dynamicLists.push({
                    id: Date.now(),
                    name: item.name,
                    words: sData,
                    relatedData: { t: tData, g: gData }
                });
            }
            saveState();
            showHomePage();
        } catch (error) {
            console.error('Error loading item from local directory:', error);
            alert(`エラー: ${error.message}`);
            throw error;
        }
      }

      async function loadItemFromRepo(item) {
        try {
          if (typeof item === 'string') { // Single file
            const response = await fetch(`./${item}`);
            if (!response.ok) throw new Error(`ファイル'${item}'を読み込めませんでした。`);
            const text = await response.text();
            const words = parseTsv(text);
            if (words.length > 0) {
              dynamicLists.push({ id: Date.now(), name: item.split('/').pop(), words });
            } else {
              throw new Error("ファイルが空か、形式が正しくありません。");
            }
          } else if (typeof item === 'object' && item.s_file) { // Set of files
            const fetchFile = async (path) => {
                if(!path) return ""; // Allow optional files
                const response = await fetch(`./${path}`);
                if (!response.ok) throw new Error(`ファイル'${path}'を読み込めませんでした。`);
                return response.text();
            };

            const [sText, tText, gText] = await Promise.all([
                fetchFile(item.s_file),
                fetchFile(item.t_file),
                fetchFile(item.g_file)
            ]);
            
            const sData = parseTsv(sText);
            if (sData.length === 0) throw new Error('メイン英文ファイルに有効なデータがありません。');
            
            const tData = tText ? parseTsv(tText) : [];
            const gData = gText ? parseTsv(gText) : [];
            
            dynamicLists.push({
                id: Date.now(),
                name: item.name,
                words: sData,
                relatedData: { t: tData, g: gData }
            });
          }
          saveState();
          showHomePage();
        } catch (error) {
          console.error('Error loading item from repo:', error);
          alert(`エラー: ${error.message}`);
          throw error;
        }
      }
      
      function openPasswordModal() {
        const modal = document.getElementById('passwordModal');
        const input = document.getElementById('passwordInput');
        const errorDiv = document.getElementById('passwordError');
        
        input.value = '';
        errorDiv.textContent = '';
        modal.style.display = 'flex';
        input.focus();

        document.getElementById('closePasswordModalBtn').onclick = closePasswordModal;
        document.getElementById('passwordSubmitBtn').onclick = checkPassword;
        modal.onclick = (e) => {
            if (e.target === modal) closePasswordModal();
        };
        input.onkeyup = (e) => {
            if (e.key === 'Enter') checkPassword();
        }
      }

      function closePasswordModal() {
          document.getElementById('passwordModal').style.display = 'none';
      }

      function checkPassword() {
          const input = document.getElementById('passwordInput');
          const errorDiv = document.getElementById('passwordError');
          const HARDCODED_PASSWORD = "1234";

          if (input.value === HARDCODED_PASSWORD) {
              closePasswordModal();
              openSettingsModal();
          } else {
              errorDiv.textContent = 'パスワードが違います。';
              input.value = '';
              input.focus();
          }
      }
      
      function openSettingsModal() {
          const modal = document.getElementById('settingsModal');
          if (!modal) return;
          modal.style.display = 'flex';
          
          const form = document.getElementById('settingsForm');
          form.querySelectorAll('input[type="number"]').forEach(input => {
              const key = input.dataset.key;
              if (key in columnSettings) {
                  input.value = columnSettings[key];
              }
          });

          modal.querySelector('.close-button').onclick = () => modal.style.display = 'none';
          document.getElementById('saveSettingsBtn').onclick = saveSettings;
          document.getElementById('resetSettingsBtn').onclick = () => {
              if (confirm('設定を初期値に戻しますか？')) {
                  columnSettings = { ...defaultColumnSettings };
                  saveState();
                  openSettingsModal(); // Re-render modal with default values
              }
          };
          modal.onclick = (e) => {
              if (e.target === modal) modal.style.display = 'none';
          };
      }

      function saveSettings() {
          const newSettings = {};
          const form = document.getElementById('settingsForm');
          form.querySelectorAll('input[type="number"]').forEach(input => {
              const key = input.dataset.key;
              newSettings[key] = parseInt(input.value, 10) || 0;
          });

          if (newSettings.english < 1 || newSettings.japanese < 1) {
              alert('英語 (カード表) と 日本語 (カード裏) の列は1以上の正の整数で指定してください。');
              return;
          }
          if (newSettings.english === newSettings.japanese) {
              alert('英語 (カード表) と 日本語 (カード裏) には異なる列を指定してください。');
              return;
          }

          columnSettings = newSettings;
          saveState();
          document.getElementById('settingsModal').style.display = 'none';
          alert('設定を保存しました。');
      }

      function getCardNumberString(word) {
        if (!word) return '';
        const mapping = columnSettings;
        const parts = [];
        const no = mapping.no > 0 && word.columns.length >= mapping.no ? word.columns[mapping.no - 1] : null;
        const unit = mapping.unit > 0 && word.columns.length >= mapping.unit ? word.columns[mapping.unit - 1] : null;
        const label = mapping.label > 0 && word.columns.length >= mapping.label ? word.columns[mapping.label - 1] : null;

        if (no) parts.push(`No:${no}`);
        if (unit) parts.push(`Unit:${unit}`);
        if (label) parts.push(label);

        return parts.join(' / ');
      }

      function showFlashcardPage(resumeState = null) {
        if (!currentList) {
          showHomePage();
          return;
        }

        let words, idx, visitedIndices, checkedItems;
        let isFlipped = resumeState?.isFlipped || false; // Restore flip state if available

        if (resumeState && resumeState.words) {
            words = resumeState.words;
            idx = resumeState.idx;
            visitedIndices = new Set(resumeState.visitedIndices);
            checkedItems = new Set(resumeState.checkedItems);
        } else {
            words = [...currentList.words];
            idx = 0;
            visitedIndices = new Set([0]);
            checkedItems = new Set();
        }

        function suspendSession() {
          if (idx >= words.length) { 
            delete progressData[currentList.id];
          } else {
            progressData[currentList.id] = {
              words: words,
              idx: idx,
              visitedIndices: Array.from(visitedIndices),
              checkedItems: Array.from(checkedItems),
            };
          }
          saveState();
          showHomePage();
        }
        
        function resetCurrentList() {
            delete progressData[currentList.id];
            saveState();
            showFlashcardPage();
        }
        
        function startReview() {
          if (checkedItems.size === 0) {
            alert("「check！」した項目はありません。");
            return;
          }
          
          let checkedWords = Array.from(checkedItems).map(i => words[i]);

          checkedWords.sort((a, b) => {
              const indexA = currentList.words.indexOf(a);
              const indexB = currentList.words.indexOf(b);
              return indexA - indexB;
          });
          words = checkedWords;
          
          idx = 0;
          visitedIndices = new Set([0]);
          checkedItems = new Set();
          isFlipped = false;
          render();
        }

        function render() {
          const checkedCount = checkedItems.size;
          const perfectCount = idx - checkedCount;
          const remainingCount = words.length - idx;

          if (idx >= words.length) {
            delete progressData[currentList.id]; 
            saveState();
            app.innerHTML = `
              <div class="container flashcard-page">
                <h1 class="title">${currentList?.name}</h1>
                <div class="card-container">
                  <div class="card done-card">
                    <div class="card-face card-front">🎉 完了！</div>
                  </div>
                </div>
                <div class="counters">
                  <span>のこり: 0</span>
                  <span>カンペキ: ${perfectCount}</span>
                  <span>check！: ${checkedCount}</span>
                </div>
                <div class="sub-btn-row">
                  <button id="resetBtn" class="sub-btn">リセット</button>
                  <button id="reviewBtn" class="sub-btn">「check！」した項目を復習</button>
                </div>
                <div class="mt-8">
                  <button id="backBtn" class="back-link">« リスト選択にもどる</button>
                </div>
              </div>
            `;
            document.getElementById("resetBtn").onclick = resetCurrentList;
            document.getElementById("reviewBtn").onclick = startReview;
            document.getElementById("backBtn").onclick = showHomePage;
            return;
          }

          const word = words[idx];
          const isChecked = checkedItems.has(idx);
          const mapping = columnSettings;
          const frontText = word.columns[mapping.english - 1] || '(データなし)';
          const backText = word.columns[mapping.japanese - 1] || '(データなし)';
          const cardNumberText = getCardNumberString(word);
          
          const gram1 = mapping.gram1 > 0 && word.columns.length >= mapping.gram1 ? word.columns[mapping.gram1 - 1] : null;
          const gram2 = mapping.gram2 > 0 && word.columns.length >= mapping.gram2 ? word.columns[mapping.gram2 - 1] : null;
          const gram3 = mapping.gram3 > 0 && word.columns.length >= mapping.gram3 ? word.columns[mapping.gram3 - 1] : null;
          const hasGrammar = gram1 || gram2 || gram3;
          let grammarHtml = '';

          if (hasGrammar) {
            if (isFlipped) {
              grammarHtml = `<div class="grammar-box">`;
              if (gram1) grammarHtml += `<div class="grammar-item"><span>文法1:</span> ${gram1}</div>`;
              if (gram2) grammarHtml += `<div class="grammar-item"><span>文法2:</span> ${gram2}</div>`;
              if (gram3) grammarHtml += `<div class="grammar-item"><span>文法3:</span> ${gram3}</div>`;
              grammarHtml += `</div>`;
            } else {
              grammarHtml = `<div class="grammar-placeholder"></div>`;
            }
          }
          
          const hasRelatedData = currentList.relatedData && currentList.relatedData.t && currentList.relatedData.g;

          app.innerHTML = `
            <div class="container flashcard-page">
              <h1 class="title">${currentList?.name}</h1>
              <div class="card-header-info">
                <div class="card-number" title="${cardNumberText}">${cardNumberText}</div>
                ${hasRelatedData ? '<button id="relatedWordsBtn" class="sub-btn">関連語</button>' : ''}
              </div>
              <div class="card-container" id="cardContainer">
                <div class="card${isFlipped ? " is-flipped" : ""}">
                  <div class="card-face card-front">${frontText}</div>
                  <div class="card-face card-back">${backText}</div>
                </div>
              </div>

              <div class="speech-controls">
                <button id="speakBtn" class="sub-btn">🔊 発音</button>
                <label for="speechRateSlider">速度</label>
                <input type="range" id="speechRateSlider" min="0.3" max="2" step="0.1" value="${speechRate}">
                <span id="speechRateValue">${speechRate.toFixed(1)}</span>
              </div>
              
              ${grammarHtml}
              <div class="counters">
                <span>のこり: ${remainingCount}</span>
                <span>カンペキ: ${perfectCount}</span>
                <span>check！: ${checkedCount}</span>
              </div>
              <div class="btn-row">
                <button id="prevBtn" class="sub-btn" ${idx === 0 ? 'disabled' : ''}>⏪ 前ページ</button>
                <button id="checkBtn" class="check-btn ${isChecked ? 'checked' : ''}">${isChecked ? '✅ check済' : '🔖 check！'}</button>
                <button id="nextBtn" class="mode-btn learn">次ページ ⏩</button>
              </div>
              <div class="sub-btn-row">
                <button id="suspendBtn" class="sub-btn">中断</button>
                <button id="resetBtn" class="sub-btn">リセット</button>
                <button id="reviewBtn" class="sub-btn">「check」を復習</button>
              </div>
              <div class="mt-8">
                <button id="backBtn" class="back-link">« リスト選択にもどる (保存されません)</button>
              </div>
            </div>
          `;

          const cardEl = document.querySelector('.card');
          if (cardEl) {
              const frontFace = cardEl.querySelector('.card-front');
              const backFace = cardEl.querySelector('.card-back');
              
              const adjustHeight = () => {
                  const frontHeight = frontFace.scrollHeight;
                  const backHeight = backFace.scrollHeight;
                  const targetHeight = isFlipped ? backHeight : frontHeight;
                  const minHeight = 250; 
                  cardEl.style.height = `${Math.max(targetHeight, minHeight)}px`;
              };
              requestAnimationFrame(adjustHeight);
          }

          const speechRateSlider = document.getElementById("speechRateSlider");
          const speechRateValue = document.getElementById("speechRateValue");
          if (speechRateSlider) {
              speechRateSlider.oninput = () => {
                  const newRate = parseFloat(speechRateSlider.value);
                  speechRate = newRate;
                  if (speechRateValue) speechRateValue.textContent = newRate.toFixed(1);
                  try {
                      localStorage.setItem(SPEECH_RATE_KEY, newRate.toString());
                  } catch (e) {
                      console.error("Failed to save speech rate:", e);
                  }
              };
          }

          document.getElementById("cardContainer").onclick = () => {
            isFlipped = !isFlipped;
            render();
          };

          const speakBtn = document.getElementById("speakBtn");
          if ('speechSynthesis' in window) {
              speakBtn.onclick = (e) => {
                  e.stopPropagation();
                  const textToSpeak = frontText;
                  window.speechSynthesis.cancel();
                  const utterance = new SpeechSynthesisUtterance(textToSpeak);
                  utterance.lang = 'en-US';
                  utterance.rate = speechRate;
                  window.speechSynthesis.speak(utterance);
              };
          } else {
              if(speakBtn) speakBtn.style.display = 'none';
          }
          
          if (hasRelatedData) {
            const relatedWordsBtn = document.getElementById("relatedWordsBtn");
            if(relatedWordsBtn) {
              relatedWordsBtn.onclick = () => {
                const stateToResume = {
                  words: words,
                  idx: idx,
                  visitedIndices: Array.from(visitedIndices),
                  checkedItems: Array.from(checkedItems),
                  isFlipped: isFlipped,
                };
                showRelatedWordsPage(word, stateToResume);
              };
            }
          }

          document.getElementById("prevBtn").onclick = () => {
            if (idx > 0) {
              idx--;
              isFlipped = false;
              render();
            }
          };

          const advancePage = () => {
            if (idx < words.length) {
              idx++;
              if (idx < words.length) {
                  visitedIndices.add(idx);
              }
              isFlipped = false;
              render();
            }
          };

          document.getElementById("nextBtn").onclick = () => {
              if (idx < words.length) {
                if (checkedItems.has(idx)) {
                    checkedItems.delete(idx);
                }
              }
              advancePage();
          };

          document.getElementById("checkBtn").onclick = () => {
              if (checkedItems.has(idx)) {
                  checkedItems.delete(idx);
              } else {
                  checkedItems.add(idx);
              }
              advancePage();
          };
          
          document.getElementById("suspendBtn").onclick = suspendSession;
          document.getElementById("resetBtn").onclick = resetCurrentList;
          document.getElementById("reviewBtn").onclick = startReview;
          document.getElementById("backBtn").onclick = showHomePage;
        }

        render();
      }

      function showRelatedWordsPage(word, cardState) {
        const sentenceIdColumnIndex = 2; // "TSVデータ列3列目" means index 2
        
        const sentenceId = word.columns.length > sentenceIdColumnIndex ? word.columns[sentenceIdColumnIndex] : null;
        const originalSentence = word.columns[columnSettings.english - 1];

        let relatedT = [];
        let relatedG = [];

        if (sentenceId && currentList.relatedData) {
          if (currentList.relatedData.t) {
            relatedT = currentList.relatedData.t.filter(row => row.columns.length > sentenceIdColumnIndex && row.columns[sentenceIdColumnIndex] === sentenceId);
          }
          if (currentList.relatedData.g) {
            relatedG = currentList.relatedData.g.filter(row => row.columns.length > sentenceIdColumnIndex && row.columns[sentenceIdColumnIndex] === sentenceId);
          }
        }
        
        const renderRelatedItems = (items, type) => {
          if (items.length === 0) return '<p class="related-item">該当データなし</p>';
          
          return items.map(item => {
            const cols = item.columns;
            let formatted = '';
            
            // Note: Column numbers from user are 1-based, array indices are 0-based.
            if (type === 't') {
              // -t: 4列目単語：6列目品詞／5列目意味／7列目／8列目／9列目
              const t_word = cols[3] ? `<strong>${cols[3]}</strong>` : ''; // 4
              const t_pos = cols[5] || ''; // 6
              const t_meaning = cols[4] || ''; // 5
              const t_rest = [cols[6], cols[7], cols[8]].filter(Boolean).join(' / '); // 7,8,9
              
              let displayParts = [];
              if (t_word && t_pos) {
                  displayParts.push(`${t_word}: ${t_pos}`);
              } else if (t_word) {
                  displayParts.push(t_word);
              }
              if (t_meaning) displayParts.push(t_meaning);
              if (t_rest) displayParts.push(t_rest);

              formatted = displayParts.join(' / ');

            } else if (type === 'g') {
              // -g: 4列目語句、5列目意味、6列目用法、7列目／8列目／9列目
              const g_phrase = cols[3] ? `<strong>${cols[3]}</strong>` : ''; // 4
              const g_meaning = cols[4] || ''; // 5
              const g_usage = cols[5] || ''; // 6
              const g_rest = [cols[6], cols[7], cols[8]].filter(Boolean).join(' / '); // 7,8,9

              let displayParts = [g_phrase, g_meaning, g_usage, g_rest].filter(Boolean);
              formatted = displayParts.join(' / ');
            }
            return `<p class="related-item">${formatted}</p>`;
          }).join('');
        };

        app.innerHTML = `
          <div class="container flashcard-page">
            <h1 class="title" style="margin-bottom: 0.5rem;">関連語</h1>
            <div class="list-card" style="width:100%; box-sizing: border-box;">
              <p style="font-size:0.9em; color: #6b7280; margin-top: 0;">原文 (文番号: ${sentenceId || 'N/A'})</p>
              <p style="font-weight: bold; margin-bottom: 0; font-size: 1.2em;">${originalSentence}</p>
            </div>
            <div class="list-card" style="width:100%; box-sizing: border-box; text-align: left;">
              <h4 style="margin-top:0; margin-bottom: 0.5rem;">関連単語 (-t)</h4>
              ${renderRelatedItems(relatedT, 't')}
            </div>
            <div class="list-card" style="width:100%; box-sizing: border-box; text-align: left;">
              <h4 style="margin-top:0; margin-bottom: 0.5rem;">関連語句 (-g)</h4>
              ${renderRelatedItems(relatedG, 'g')}
            </div>
            <div class="mt-8 text-center" style="width: 100%;">
                <button id="backToCardBtn" class="mode-btn learn">カードに戻る</button>
            </div>
          </div>
        `;

        document.getElementById('backToCardBtn').onclick = () => {
            showFlashcardPage(cardState);
        };
      }

      function initializeApp() {
          loadState();
          showHomePage();
      }

      initializeApp();
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>